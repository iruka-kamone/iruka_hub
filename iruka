local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local MOVE_SPEED = 300
local camLockPart = "Head"

-- 追尾用透明パーツ
local followPlatform = nil
local currentTween = nil
local followConnection = nil
local ignoreWalls = true
local bloxFruitsMode = false

local selectedTarget = nil
local moving = false
local camLock = false
local randomMode = false
local sameTeamEnabled = false
local randomTypeClose = true

local islands = {
	Vector3.new(-287, 305.9, 597.6),
	Vector3.new(2284.9, 14.9, 905.8),
	Vector3.new(923.2, 124.8, 32852.8),
	Vector3.new(-6508.6, 82, -132.8),
}

local function createFollowPlatform(position)
	if followPlatform then
		followPlatform:Destroy()
	end
	followPlatform = Instance.new("Part")
	followPlatform.Size = Vector3.new(4, 1, 4)
	followPlatform.Anchored = true
	followPlatform.CanCollide = false
	followPlatform.Transparency = 1
	followPlatform.Position = position
	followPlatform.Parent = workspace
end

local function destroyFollowPlatform()
	if followPlatform then
		followPlatform:Destroy()
		followPlatform = nil
	end
	if followConnection then
		followConnection:Disconnect()
		followConnection = nil
	end
	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end
end

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FollowGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- メインフレーム
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 450, 0, 300)
mainFrame.Position = UDim2.new(0.3, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BackgroundTransparency = 0.3
mainFrame.BorderSizePixel = 0
mainFrame.ClipsDescendants = true
mainFrame.Active = true
mainFrame.Draggable = true
local mainCorner = Instance.new("UICorner", mainFrame)
mainCorner.CornerRadius = UDim.new(0, 20)

-- タイトルバー
local titleBar = Instance.new("Frame", mainFrame)
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
local titleCorner = Instance.new("UICorner", titleBar)
titleCorner.CornerRadius = UDim.new(0, 20)

local titleLabel = Instance.new("TextLabel", titleBar)
titleLabel.Size = UDim2.new(1, -80, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Iruka Hub"
titleLabel.TextColor3 = Color3.new(1, 1, 1)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 20
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", titleBar)
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -32, 0, 2)
closeButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.Text = "X"
closeButton.Font = Enum.Font.GothamBold
closeButton.TextSize = 22
local closeCorner = Instance.new("UICorner", closeButton)
closeCorner.CornerRadius = UDim.new(1, 0)

-- 右列フレーム（スクロール可能ボタン群 + スイッチ群）
local rightFrame = Instance.new("Frame", mainFrame)
rightFrame.Size = UDim2.new(0, 250, 1, -35)
rightFrame.Position = UDim2.new(0, 180, 0, 35)
rightFrame.BackgroundTransparency = 1

local buttonScroll = Instance.new("ScrollingFrame", rightFrame)
buttonScroll.Size = UDim2.new(1, 0, 1, 0)
buttonScroll.BackgroundTransparency = 1
buttonScroll.ScrollBarThickness = 6
buttonScroll.ClipsDescendants = true

local buttonLayout = Instance.new("UIListLayout", buttonScroll)
buttonLayout.SortOrder = Enum.SortOrder.LayoutOrder
buttonLayout.Padding = UDim.new(0, 6)

-- 左列フレーム（Player選択 + Speed）
local leftFrame = Instance.new("Frame", mainFrame)
leftFrame.Size = UDim2.new(0, 180, 1, -35)
leftFrame.Position = UDim2.new(0, 0, 0, 35)
leftFrame.BackgroundTransparency = 1

-- Player ドロップダウン
local dropdown = Instance.new("TextButton", leftFrame)
dropdown.Size = UDim2.new(0, 160, 0, 30)
dropdown.Position = UDim2.new(0, 10, 0, 10)
dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dropdown.TextColor3 = Color3.new(1, 1, 1)
dropdown.Text = "Select Player"
dropdown.Font = Enum.Font.GothamBold
dropdown.TextSize = 14

local dropdownFrame = Instance.new("ScrollingFrame", leftFrame)
dropdownFrame.Size = UDim2.new(0, 160, 0, 120)
dropdownFrame.Position = UDim2.new(0, 10, 0, 40)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
dropdownFrame.Visible = false
dropdownFrame.ClipsDescendants = true
dropdownFrame.BorderSizePixel = 0
dropdownFrame.ScrollBarThickness = 6

local uiListLayout = Instance.new("UIListLayout", dropdownFrame)
uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
uiListLayout.Padding = UDim.new(0, 4)

-- Home/ESP タブ
local tabFrame = Instance.new("Frame", titleBar)
tabFrame.Position = UDim2.new(0, 120, 0, 2)
tabFrame.Size = UDim2.new(0, 80, 1, -4)
tabFrame.BackgroundTransparency = 1

local homeButton = Instance.new("TextButton", tabFrame)
homeButton.Size = UDim2.new(0.5, -2, 1, -4)
homeButton.Position = UDim2.new(0, 0, 0, 2)
homeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
homeButton.TextColor3 = Color3.new(1, 1, 1)
homeButton.Text = "Home"
homeButton.Font = Enum.Font.GothamBold
homeButton.TextSize = 14
local homeCorner = Instance.new("UICorner", homeButton)
homeCorner.CornerRadius = UDim.new(0, 6)

local espButton = Instance.new("TextButton", tabFrame)
espButton.Size = UDim2.new(0.5, -2, 1, -4)
espButton.Position = UDim2.new(0.5, 2, 0, 2)
espButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
espButton.TextColor3 = Color3.new(1, 1, 1)
espButton.Text = "ESP"
espButton.Font = Enum.Font.GothamBold
espButton.TextSize = 14
local espCorner = Instance.new("UICorner", espButton)
espCorner.CornerRadius = UDim.new(0, 6)

-- ページ切り替え関数
local currentPage = "Home"
local function switchPage(page)
	currentPage = page
	if page == "Home" then
		leftFrame.Visible = true
		rightFrame.Visible = true
	elseif page == "ESP" then
		leftFrame.Visible = false
		rightFrame.Visible = false
	end
end

homeButton.MouseButton1Click:Connect(function()
	switchPage("Home")
end)

espButton.MouseButton1Click:Connect(function()
	switchPage("ESP")
end)

switchPage("Home")

-- Speed入力
local speedLabel = Instance.new("TextLabel", leftFrame)
speedLabel.Size = UDim2.new(0, 80, 0, 30)
speedLabel.Position = UDim2.new(0, 10, 0, 180)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "Speed:"
speedLabel.TextColor3 = Color3.new(1, 1, 1)
speedLabel.Font = Enum.Font.GothamBold
speedLabel.TextSize = 14
speedLabel.TextXAlignment = Enum.TextXAlignment.Left

local speedBox = Instance.new("TextBox", leftFrame)
speedBox.Size = UDim2.new(0, 80, 0, 30)
speedBox.Position = UDim2.new(0, 60, 0, 180)
speedBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedBox.TextColor3 = Color3.new(1, 1, 1)
speedBox.Text = tostring(MOVE_SPEED)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.ClearTextOnFocus = false
speedBox.TextEditable = true

speedBox.FocusLost:Connect(function()
	local newSpeed = tonumber(speedBox.Text)
	if newSpeed and newSpeed > 0 then
		MOVE_SPEED = newSpeed
		speedBox.Text = tostring(MOVE_SPEED)
	else
		speedBox.Text = tostring(MOVE_SPEED)
	end
end)

-- Toggle GUI
local toggleButton = Instance.new("ImageButton")
toggleButton.Size = UDim2.new(0, 50, 0, 50)
toggleButton.Position = UDim2.new(0, 100, 0, 100)
toggleButton.BackgroundTransparency = 1
toggleButton.Image = "rbxassetid://125855645824065"
toggleButton.Parent = screenGui
toggleButton.Active = true
toggleButton.Draggable = true
local toggleCorner = Instance.new("UICorner", toggleButton)
toggleCorner.CornerRadius = UDim.new(0.25, 0)

toggleButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

local function updatePlayerList()
	-- 既存のリストをクリア
	for _, child in ipairs(dropdownFrame:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end

	-- 全プレイヤーを追加
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player then
			local btn = Instance.new("TextButton")
			btn.Size = UDim2.new(1, -10, 0, 30)
			btn.Position = UDim2.new(0, 5, 0, 0)
			btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
			btn.TextColor3 = Color3.new(1, 1, 1)
			btn.Text = plr.Name
			btn.Font = Enum.Font.GothamBold
			btn.TextSize = 14
			btn.AutoButtonColor = true
			btn.Parent = dropdownFrame

			btn.MouseButton1Click:Connect(function()
				selectedTarget = plr
				dropdown.Text = "Target: " .. plr.Name
				dropdownFrame.Visible = false
			end)
		end
	end

	-- UIListLayoutで自動整列
	local layout = dropdownFrame:FindFirstChildOfClass("UIListLayout")
	if not layout then
		layout = Instance.new("UIListLayout")
		layout.Parent = dropdownFrame
		layout.SortOrder = Enum.SortOrder.LayoutOrder
		layout.Padding = UDim.new(0, 4)
	end

	-- CanvasSizeを自動調整
	dropdownFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
	dropdownFrame.Visible = false  -- ← ここを追加
end


dropdown.MouseButton1Click:Connect(function()
	dropdownFrame.Visible = not dropdownFrame.Visible
end)

-- 🟢 共通スイッチ作成関数
local function createSwitch(parent, text, default, callback)
	local frame = Instance.new("Frame", parent)
	frame.Size = UDim2.new(1, -10, 0, 40)
	frame.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", frame)
	label.Size = UDim2.new(0.6, 0, 1, 0)
	label.Position = UDim2.new(0, 0, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3.new(1, 1, 1)

	local switchBase = Instance.new("Frame", frame)
	switchBase.Size = UDim2.new(0, 50, 0, 24)
	switchBase.Position = UDim2.new(1, -60, 0.5, -12)
	switchBase.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	switchBase.BackgroundTransparency = 0.3
	local baseCorner = Instance.new("UICorner", switchBase)
	baseCorner.CornerRadius = UDim.new(1, 0)

	local handle = Instance.new("Frame", switchBase)
	handle.Size = UDim2.new(0, 20, 0, 20)
	handle.Position = UDim2.new(0, 2, 0.5, -10)
	handle.BackgroundColor3 = Color3.new(1, 1, 1)
	local handleCorner = Instance.new("UICorner", handle)
	handleCorner.CornerRadius = UDim.new(1, 0)

	local state = default or false
	local function updateUI()
		if state then
			switchBase.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
			handle:TweenPosition(UDim2.new(1, -22, 0.5, -10), "Out", "Quad", 0.2, true)
		else
			switchBase.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
			handle:TweenPosition(UDim2.new(0, 2, 0.5, -10), "Out", "Quad", 0.2, true)
		end
	end

	switchBase.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			state = not state
			updateUI()
			if callback then callback(state) end
		end
	end)

	updateUI()
	return frame
end

-- Refresh ボタン（普通のボタン）
local refreshButton = Instance.new("TextButton", buttonScroll)
refreshButton.Size = UDim2.new(1, -10, 0, 40)
refreshButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
refreshButton.TextColor3 = Color3.new(1, 1, 1)
refreshButton.Text = "Refresh"
refreshButton.Font = Enum.Font.GothamBold
refreshButton.TextSize = 14

refreshButton.MouseButton1Click:Connect(function()
	updatePlayerList()
end)

createSwitch(buttonScroll, "Move to Target", false, function(state)
	moving = state
end)
createSwitch(buttonScroll, "Cam Lock", false, function(state)
	camLock = state
end)
createSwitch(buttonScroll, "Random", false, function(state)
	randomMode = state
end)
createSwitch(buttonScroll, "Same Team", false, function(state)
	sameTeamEnabled = state
end)
createSwitch(buttonScroll, "Random Type (Close/Full)", true, function(state)
	randomTypeClose = state
end)
createSwitch(buttonScroll, "Ignore Walls", true, function(state)
	ignoreWalls = state
end)
createSwitch(buttonScroll, "Blox Fruits Mode", false, function(state)
	bloxFruitsMode = state
end)

-- 🟢 Look Part ドロップダウン
local lookParts = {"Head", "Torso","Legs"}
local currentLookPart = "Head"

local lookDropdownFrame = Instance.new("Frame", buttonScroll)
lookDropdownFrame.Size = UDim2.new(1, -10, 0, 40)
lookDropdownFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
lookDropdownFrame.BackgroundTransparency = 0.3

local dropdownCorner = Instance.new("UICorner", lookDropdownFrame)
dropdownCorner.CornerRadius = UDim.new(0, 8)

local dropdownLabel = Instance.new("TextLabel", lookDropdownFrame)
dropdownLabel.Size = UDim2.new(1, -20, 1, 0)
dropdownLabel.Position = UDim2.new(0, 10, 0, 0)
dropdownLabel.BackgroundTransparency = 1
dropdownLabel.Text = "Look Part: " .. currentLookPart
dropdownLabel.Font = Enum.Font.GothamBold
dropdownLabel.TextSize = 14
dropdownLabel.TextColor3 = Color3.new(1, 1, 1)
dropdownLabel.TextXAlignment = Enum.TextXAlignment.Left

lookDropdownFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		local index = table.find(lookParts, currentLookPart)
		local nextIndex = index % #lookParts + 1
		currentLookPart = lookParts[nextIndex]
		dropdownLabel.Text = "Look Part: " .. currentLookPart
		camLockPart = currentLookPart
	end
end)

-- スクロール範囲自動調整
buttonLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	buttonScroll.CanvasSize = UDim2.new(0, 0, 0, buttonLayout.AbsoluteContentSize.Y + 20)
end)

buttonScroll.CanvasSize = UDim2.new(0, 0, 0, buttonLayout.AbsoluteContentSize.Y + 40)

-- Raycast でターゲットとの間に壁があるかチェック
local function isVisible(target)
	if not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then
		return false
	end
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
		return false
	end

	local origin = player.Character.HumanoidRootPart.Position

	local targetPos
	if camLockPart == "Head" and target.Character:FindFirstChild("Head") then
		targetPos = target.Character.Head.Position
	elseif camLockPart == "Torso" and target.Character:FindFirstChild("HumanoidRootPart") then
		targetPos = target.Character.HumanoidRootPart.Position
	elseif camLockPart == "Legs" and target.Character:FindFirstChild("HumanoidRootPart") then
		targetPos = target.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
	else
		targetPos = target.Character.HumanoidRootPart.Position
	end

	local direction = targetPos - origin

	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = {player.Character, target.Character}
	raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

	local result = workspace:Raycast(origin, direction, raycastParams)
	if result then
		-- 途中で遮蔽物に当たった
		return false
	end
	return true
end

-- Pick random target based on settings
local function pickRandomTarget()
	local candidates = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
			-- チーム判定
			if not sameTeamEnabled and player.Team and plr.Team == player.Team then
				-- Skip same team
			else
				-- 壁を無視しない設定なら可視判定
				if ignoreWalls or isVisible(plr) then
					table.insert(candidates, plr)
				end
			end
		end
	end

	if #candidates == 0 then
		selectedTarget = nil
		dropdown.Text = "Select Player"
		return
	end

	if randomTypeClose then
		-- Close mode: pick closest target, update every 0.1s
		table.sort(candidates, function(a,b)
			if not (a.Character and a.Character:FindFirstChild("HumanoidRootPart")) then return false end
			if not (b.Character and b.Character:FindFirstChild("HumanoidRootPart")) then return true end
			local aPos = a.Character.HumanoidRootPart.Position
			local bPos = b.Character.HumanoidRootPart.Position
			local myPos = player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.Position or Vector3.new()
			return (aPos - myPos).Magnitude < (bPos - myPos).Magnitude
		end)
		selectedTarget = candidates[1]
	else
		-- Full mode: pick random target and stay until dead
		if selectedTarget and selectedTarget.Character and selectedTarget.Character:FindFirstChild("Humanoid") and selectedTarget.Character.Humanoid.Health > 0 then
			return -- keep current target alive in full mode
		end
		selectedTarget = candidates[math.random(1,#candidates)]
	end

	if selectedTarget then
		dropdown.Text = "Target: " .. selectedTarget.Name
	end
end

updatePlayerList()

closeButton.MouseButton1Click:Connect(function()
	-- 確認ダイアログ作成
	local confirmFrame = Instance.new("Frame")
	confirmFrame.Size = UDim2.new(0, 250, 0, 120)
	confirmFrame.Position = UDim2.new(0.5, -125, 0.5, -60)
	confirmFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	confirmFrame.BorderSizePixel = 0
	confirmFrame.Parent = screenGui
	confirmFrame.ZIndex = 10

	local label = Instance.new("TextLabel", confirmFrame)
	label.Size = UDim2.new(1, -20, 0, 50)
	label.Position = UDim2.new(0, 10, 0, 10)
	label.BackgroundTransparency = 1
	label.Text = "Really Close?"
	label.TextColor3 = Color3.new(1,1,1)
	label.Font = Enum.Font.GothamBold
	label.TextSize = 18
	label.TextWrapped = true
	label.ZIndex =11

	local yesButton = Instance.new("TextButton", confirmFrame)
	yesButton.Size = UDim2.new(0.4, 0, 0, 40)
	yesButton.Position = UDim2.new(0.05, 0, 0.6, 0)
	yesButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
	yesButton.TextColor3 = Color3.new(1,1,1)
	yesButton.Text = "Yes"
	yesButton.Font = Enum.Font.GothamBold
	yesButton.TextSize = 16
	yesButton.ZIndex = 11

	local noButton = Instance.new("TextButton", confirmFrame)
	noButton.Size = UDim2.new(0.4, 0, 0, 40)
	noButton.Position = UDim2.new(0.55, 0, 0.6, 0)
	noButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	noButton.TextColor3 = Color3.new(1,1,1)
	noButton.Text = "No"
	noButton.Font = Enum.Font.GothamBold
	noButton.TextSize = 16
	noButton.ZIndex =11

	yesButton.MouseButton1Click:Connect(function()
		screenGui:Destroy()
		destroyFollowPlatform()
	end)

	noButton.MouseButton1Click:Connect(function()
		confirmFrame:Destroy()
	end)
end)

-- Tweenでなめらか追尾処理
local function teleportTo(position)
	if not player.Character then return end
	local hrp = player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	if not followPlatform or not followPlatform.Parent then
		createFollowPlatform(hrp.Position - Vector3.new(0, 2.5, 0))
	end

	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end
	if followConnection then
		followConnection:Disconnect()
		followConnection = nil
	end

	local distance = (position - followPlatform.Position).Magnitude
	local time = distance / MOVE_SPEED

	currentTween = TweenService:Create(followPlatform, TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {Position = position})

	followConnection = RunService.RenderStepped:Connect(function()
		if followPlatform and followPlatform.Parent and hrp.Parent then
			hrp.CFrame = CFrame.new(
				followPlatform.Position + Vector3.new(0, 2.5, 0),
				followPlatform.Position + followPlatform.CFrame.LookVector
			)
		end
	end)

	currentTween:Play()
	currentTween.Completed:Connect(function()
		if followConnection then
			followConnection:Disconnect()
			followConnection = nil
		end
	end)
end

local function getClosestIslandToTarget(targetPos)
	local closestIsland = nil
	local closestDist = math.huge
	for _, island in ipairs(islands) do
		local dist = (targetPos - island).Magnitude
		if dist < closestDist then
			closestDist = dist
			closestIsland = island
		end
	end
	return closestIsland, closestDist
end

-- CamLock処理
RunService.Heartbeat:Connect(function()
	if camLock and selectedTarget and selectedTarget.Character then
		local cam = workspace.CurrentCamera
		local lookPos = nil

		if camLockPart == "Head" and selectedTarget.Character:FindFirstChild("Head") then
			lookPos = selectedTarget.Character.Head.Position
		elseif camLockPart == "Torso" and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
			lookPos = selectedTarget.Character.HumanoidRootPart.Position
		elseif camLockPart == "Legs" and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
			lookPos = selectedTarget.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
		end
		
		if lookPos then
			cam.CFrame = CFrame.new(cam.CFrame.Position, lookPos)
		end
	end
end)

local lastDistance = nil  -- 前フレームの距離を記録

RunService.Heartbeat:Connect(function()
	if randomMode then
		if randomTypeClose then
			pickRandomTarget()
		end
	end

	if moving and selectedTarget and selectedTarget.Character and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			local targetPos = selectedTarget.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
			local distance = (hrp.Position - targetPos).Magnitude

			if bloxFruitsMode then
				-- ターゲット基準で一番近い島を探す
				local island, islandDist = getClosestIslandToTarget(targetPos)
				if island then
					local myDist = (hrp.Position - targetPos).Magnitude

					-- 島の方が近ければ島にTPして追尾
					if islandDist < myDist then
						hrp.CFrame = CFrame.new(island)
						destroyFollowPlatform()
						teleportTo(targetPos)
						lastDistance = distance
						return
					end
				end

				if lastDistance and (distance - lastDistance) > 2000 then
					if island and islandDist < (hrp.Position - targetPos).Magnitude then
						-- 島が有効 → 島にTPして追尾継続
						hrp.CFrame = CFrame.new(island)
						destroyFollowPlatform()
						teleportTo(targetPos)
						lastDistance = distance
						return
					else
						-- 島もダメなら追尾停止
						destroyFollowPlatform()
						moving = false
						lastDistance = nil
						return
					end
				end
			end

			-- 通常追尾
			teleportTo(targetPos)
			lastDistance = distance
		end
	else
		destroyFollowPlatform()
		lastDistance = nil
	end
end)
