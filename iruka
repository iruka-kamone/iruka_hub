local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local MOVE_SPEED = 300
local camLockPart = "Head"

-- 追尾用透明パーツ
local followPlatform = nil
local currentTween = nil
local followConnection = nil
local ignoreWalls = true


local function createFollowPlatform(position)
	if followPlatform then
		followPlatform:Destroy()
	end
	followPlatform = Instance.new("Part")
	followPlatform.Size = Vector3.new(4, 1, 4)
	followPlatform.Anchored = true
	followPlatform.CanCollide = false
	followPlatform.Transparency = 1
	followPlatform.Position = position
	followPlatform.Parent = workspace
end

local function destroyFollowPlatform()
	if followPlatform then
		followPlatform:Destroy()
		followPlatform = nil
	end
	if followConnection then
		followConnection:Disconnect()
		followConnection = nil
	end
	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end
end

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local MOVE_SPEED = 300
local camLockPart = "Head"

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local MOVE_SPEED = 300
local camLockPart = "Head"

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FollowGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- メインフレーム
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 450, 0, 300)
mainFrame.Position = UDim2.new(0.3, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BackgroundTransparency = 0.3 
mainFrame.BorderSizePixel = 0
mainFrame.ClipsDescendants = true
mainFrame.Active = true
mainFrame.Draggable = true
local mainCorner =Instance.new("UICorner",mainFrame)
mainCorner.CornerRadius = UDim.new(0,20)

-- タイトルバー
local titleBar = Instance.new("Frame", mainFrame)
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
local titleCorner =Instance.new("UICorner",titleBar)
titleCorner.CornerRadius = UDim.new(0,20)

local titleLabel = Instance.new("TextLabel", titleBar)
titleLabel.Size = UDim2.new(1, -80, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Iruka Hub"
titleLabel.TextColor3 = Color3.new(1, 1, 1)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 20
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", titleBar)
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -32, 0, 2)
closeButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.Text = "X"
closeButton.Font = Enum.Font.GothamBold
closeButton.TextSize = 22
local closeCorner =Instance.new("UICorner",closeButton)
closeCorner.CornerRadius = UDim.new(1,0)


-- 左列フレーム（Player選択 + Speed）
local leftFrame = Instance.new("Frame", mainFrame)
leftFrame.Size = UDim2.new(0, 180, 1, -35)
leftFrame.Position = UDim2.new(0, 0, 0, 35)
leftFrame.BackgroundTransparency = 1

-- Player ドロップダウン
local dropdown = Instance.new("TextButton", leftFrame)
dropdown.Size = UDim2.new(0, 160, 0, 30)
dropdown.Position = UDim2.new(0, 10, 0, 10)
dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dropdown.TextColor3 = Color3.new(1, 1, 1)
dropdown.Text = "Select Player"
dropdown.Font = Enum.Font.GothamBold
dropdown.TextSize = 14

local dropdownFrame = Instance.new("ScrollingFrame", leftFrame)
dropdownFrame.Size = UDim2.new(0, 160, 0, 120)
dropdownFrame.Position = UDim2.new(0, 10, 0, 45)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
dropdownFrame.Visible = false
dropdownFrame.ClipsDescendants = true
dropdownFrame.BorderSizePixel = 0
dropdownFrame.ScrollBarThickness = 6

local uiListLayout = Instance.new("UIListLayout", dropdownFrame)
uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
uiListLayout.Padding = UDim.new(0, 4)

-- Speed入力
local speedLabel = Instance.new("TextLabel", leftFrame)
speedLabel.Size = UDim2.new(0, 80, 0, 30)
speedLabel.Position = UDim2.new(0, 10, 0, 180)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "Speed:"
speedLabel.TextColor3 = Color3.new(1, 1, 1)
speedLabel.Font = Enum.Font.GothamBold
speedLabel.TextSize = 14
speedLabel.TextXAlignment = Enum.TextXAlignment.Left

local speedBox = Instance.new("TextBox", leftFrame)
speedBox.Size = UDim2.new(0, 80, 0, 30)
speedBox.Position = UDim2.new(0, 60, 0, 180)
speedBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedBox.TextColor3 = Color3.new(1, 1, 1)
speedBox.Text = tostring(MOVE_SPEED)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.ClearTextOnFocus = false
speedBox.TextEditable = true

-- 右列フレーム（スクロール可能ボタン群）
local rightFrame = Instance.new("Frame", mainFrame)
rightFrame.Size = UDim2.new(0, 250, 1, -35)
rightFrame.Position = UDim2.new(0, 180, 0, 35)
rightFrame.BackgroundTransparency = 1

local buttonScroll = Instance.new("ScrollingFrame", rightFrame)
buttonScroll.Size = UDim2.new(1, 0, 1, 0)
buttonScroll.BackgroundTransparency = 1
buttonScroll.ScrollBarThickness = 6
buttonScroll.ClipsDescendants = true

local buttonLayout = Instance.new("UIListLayout", buttonScroll)
buttonLayout.SortOrder = Enum.SortOrder.LayoutOrder
buttonLayout.Padding = UDim.new(0, 6)

-- ボタン作成関数
local function makeButton(text, color)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, 0, 0, 38)
	btn.BackgroundColor3 = color
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 16
	btn.Parent = buttonScroll
	return btn
end

-- ボタン例
local refreshButton = makeButton("Refresh", Color3.fromRGB(70, 70, 70))
local moveButton = makeButton("Move: OFF", Color3.fromRGB(70, 70, 70))
local camButton = makeButton("Cam Lock: OFF", Color3.fromRGB(90, 90, 90))
local randomButton = makeButton("Random: OFF", Color3.fromRGB(110, 110, 110))
local sameTeamButton = makeButton("Same Team: OFF", Color3.fromRGB(100, 100, 150))
local randomTypeButton = makeButton("Random Type: Close", Color3.fromRGB(100, 150, 100))
local wallToggleButton = makeButton("Ignore Walls: ON", Color3.fromRGB(120, 120, 120))
local lookPartButton = makeButton("Look Part: Head", Color3.fromRGB(80, 80, 200))

-- Look Part ドロップダウン
local lookPartDropdown = Instance.new("Frame")
lookPartDropdown.Size = UDim2.new(1, 0, 0, 120)
lookPartDropdown.Position = UDim2.new(0, 0, 0, 38)
lookPartDropdown.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
lookPartDropdown.Visible = false
lookPartDropdown.BorderSizePixel = 0
lookPartDropdown.Parent = buttonScroll

local lookListLayout = Instance.new("UIListLayout", lookPartDropdown)
lookListLayout.SortOrder = Enum.SortOrder.LayoutOrder
lookListLayout.Padding = UDim.new(0, 4)

-- 選択肢
local function makeLookOption(name)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, 0, 0, 30)
	btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Text = name
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.Parent = lookPartDropdown
	btn.MouseButton1Click:Connect(function()
		lookPartButton.Text = "Look Part: " .. name
		lookPartDropdown.Visible = false
		camLockPart = name
	end)
end

makeLookOption("Head")
makeLookOption("Torso")
makeLookOption("Legs")

-- スクロール範囲自動調整
buttonLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	buttonScroll.CanvasSize = UDim2.new(0, 0, 0, buttonLayout.AbsoluteContentSize.Y + 20)
end)

-- CanvasSize自動更新
buttonScroll.CanvasSize = UDim2.new(0, 0, 0, buttonLayout.AbsoluteContentSize.Y + 40)

local toggleButton = Instance.new("ImageButton")
toggleButton.Size = UDim2.new(0, 50, 0, 50)  -- 小さい正方形
toggleButton.Position = UDim2.new(0, 100, 0, 100) -- 初期位置
toggleButton.BackgroundTransparency = 1
toggleButton.Image = "rbxassetid://125855645824065"  -- 画像ID
toggleButton.Parent = screenGui
toggleButton.Active = true
toggleButton.Draggable = true  -- ドラッグ可能
local toggleCorner =Instance.new("UICorner",toggleButton)
toggleCorner.CornerRadius = UDim.new(0.25,0)


-- State variables
local selectedTarget = nil
local targetBillboard = nil
local targetBoxBillboard = nil
local targetBillboardConnection = nil
local moving = false
local camLock = false
local randomMode = false
local sameTeamEnabled = false
local randomTypeClose = true
local minimized = false

speedBox.FocusLost:Connect(function(enterPressed)
	local newSpeed = tonumber(speedBox.Text)
	if newSpeed and newSpeed > 0 then
		MOVE_SPEED = newSpeed
		speedBox.Text = tostring(MOVE_SPEED)
	else
		speedBox.Text = tostring(MOVE_SPEED) -- 無効入力なら元の値に戻す
	end
end)

toggleButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

local function updateButtonsText()
	moveButton.Text = moving and "Move: ON" or "Move: OFF"
	camButton.Text = camLock and "Cam Lock: ON" or "Cam Lock: OFF"
	randomButton.Text = randomMode and "Random: ON" or "Random: OFF"
	sameTeamButton.Text = sameTeamEnabled and "Same Team: ON" or "Same Team: OFF"
	randomTypeButton.Text = randomTypeClose and "Random Type: Close" or "Random Type: Full"
	wallToggleButton.Text = "Ignore Walls: " .. (ignoreWalls and "ON" or "OFF")
end

-- Update player list dropdown
local function updatePlayerList()
	dropdownFrame:ClearAllChildren()
	uiListLayout = Instance.new("UIListLayout", dropdownFrame)
	uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
	uiListLayout.Padding = UDim.new(0, 4)

	local count = 0

	-- Add 'None' option
	local noneBtn = Instance.new("TextButton", dropdownFrame)
	noneBtn.Size = UDim2.new(1, 0, 0, 30)
	noneBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
	noneBtn.TextColor3 = Color3.new(1, 1, 1)
	noneBtn.Text = "None"
	noneBtn.Font = Enum.Font.GothamBold
	noneBtn.TextSize = 16
	noneBtn.MouseButton1Click:Connect(function()
		selectedTarget = nil
		dropdown.Text = "Select Player"
		randomMode = false
		updateButtonsText()
	end)
	count += 1

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player then
			local btn = Instance.new("TextButton", dropdownFrame)
			btn.Size = UDim2.new(1, 0, 0, 30)
			btn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
			btn.TextColor3 = Color3.new(1, 1, 1)
			btn.Text = plr.Name
			btn.Font = Enum.Font.GothamBold
			btn.TextSize = 16

			btn.MouseButton1Click:Connect(function()
				selectedTarget = plr
				dropdown.Text = "Target: " .. plr.Name
				dropdownFrame.Visible = false
				randomMode = false
				updateButtonsText()
			end)
			count += 1
		end
	end
	dropdownFrame.CanvasSize = UDim2.new(0, 0, 0, count * 34)
end

-- Raycast でターゲットとの間に壁があるかチェック
local function isVisible(target)
	if not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then
		return false
	end
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
		return false
	end

	local origin = player.Character.HumanoidRootPart.Position

	local targetPos
	if camLockPart == "Head" and target.Character:FindFirstChild("Head") then
		targetPos = target.Character.Head.Position
	elseif camLockPart == "Torso" and target.Character:FindFirstChild("HumanoidRootPart") then
		targetPos = target.Character.HumanoidRootPart.Position
	elseif camLockPart == "Legs" and target.Character:FindFirstChild("HumanoidRootPart") then
		targetPos = target.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
	else
		targetPos = target.Character.HumanoidRootPart.Position
	end

	local direction = targetPos - origin

	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = {player.Character, target.Character}
	raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

	local result = workspace:Raycast(origin, direction, raycastParams)
	if result then
		-- 途中で遮蔽物に当たった
		return false
	end
	return true
end

-- Pick random target based on settings
local function pickRandomTarget()
	local candidates = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
			-- チーム判定
			if not sameTeamEnabled and player.Team and plr.Team == player.Team then
				-- Skip same team
			else
				-- 壁を無視しない設定なら可視判定
				if ignoreWalls or isVisible(plr) then
					table.insert(candidates, plr)
				end
			end
		end
	end

	if #candidates == 0 then
		selectedTarget = nil
		dropdown.Text = "Select Player"
		return
	end

	if randomTypeClose then
		-- Close mode: pick closest target, update every 0.1s
		table.sort(candidates, function(a,b)
			if not (a.Character and a.Character:FindFirstChild("HumanoidRootPart")) then return false end
			if not (b.Character and b.Character:FindFirstChild("HumanoidRootPart")) then return true end
			local aPos = a.Character.HumanoidRootPart.Position
			local bPos = b.Character.HumanoidRootPart.Position
			local myPos = player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.Position or Vector3.new()
			return (aPos - myPos).Magnitude < (bPos - myPos).Magnitude
		end)
		selectedTarget = candidates[1]
	else
		-- Full mode: pick random target and stay until dead
		if selectedTarget and selectedTarget.Character and selectedTarget.Character:FindFirstChild("Humanoid") and selectedTarget.Character.Humanoid.Health > 0 then
			return -- keep current target alive in full mode
		end
		selectedTarget = candidates[math.random(1,#candidates)]
	end

	if selectedTarget then
		dropdown.Text = "Target: " .. selectedTarget.Name
	end
end

updatePlayerList()
updateButtonsText()

-- Button click events
dropdown.MouseButton1Click:Connect(function()
	dropdownFrame.Visible = not dropdownFrame.Visible
end)

refreshButton.MouseButton1Click:Connect(function()
	updatePlayerList()
end)

moveButton.MouseButton1Click:Connect(function()
	moving = not moving
	updateButtonsText()
end)

camButton.MouseButton1Click:Connect(function()
	camLock = not camLock
	updateButtonsText()
end)

randomButton.MouseButton1Click:Connect(function()
	randomMode = not randomMode
	if randomMode then
		pickRandomTarget()
	end
	updateButtonsText()
end)

sameTeamButton.MouseButton1Click:Connect(function()
	sameTeamEnabled = not sameTeamEnabled
	updateButtonsText()
end)

randomTypeButton.MouseButton1Click:Connect(function()
	randomTypeClose = not randomTypeClose
	updateButtonsText()
end)

wallToggleButton.MouseButton1Click:Connect(function()
	ignoreWalls = not ignoreWalls
	updateButtonsText()
end)


lookPartButton.MouseButton1Click:Connect(function()
	lookPartDropdown.Visible = not lookPartDropdown.Visible
end)

closeButton.MouseButton1Click:Connect(function()
	-- 確認ダイアログ作成
	local confirmFrame = Instance.new("Frame")
	confirmFrame.Size = UDim2.new(0, 250, 0, 120)
	confirmFrame.Position = UDim2.new(0.5, -125, 0.5, -60)
	confirmFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	confirmFrame.BorderSizePixel = 0
	confirmFrame.Parent = screenGui
	confirmFrame.ZIndex = 10

	local label = Instance.new("TextLabel", confirmFrame)
	label.Size = UDim2.new(1, -20, 0, 50)
	label.Position = UDim2.new(0, 10, 0, 10)
	label.BackgroundTransparency = 1
	label.Text = "Really Close?"
	label.TextColor3 = Color3.new(1,1,1)
	label.Font = Enum.Font.GothamBold
	label.TextSize = 18
	label.TextWrapped = true
	label.ZIndex =11

	local yesButton = Instance.new("TextButton", confirmFrame)
	yesButton.Size = UDim2.new(0.4, 0, 0, 40)
	yesButton.Position = UDim2.new(0.05, 0, 0.6, 0)
	yesButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
	yesButton.TextColor3 = Color3.new(1,1,1)
	yesButton.Text = "Yes"
	yesButton.Font = Enum.Font.GothamBold
	yesButton.TextSize = 16
	yesButton.ZIndex = 11

	local noButton = Instance.new("TextButton", confirmFrame)
	noButton.Size = UDim2.new(0.4, 0, 0, 40)
	noButton.Position = UDim2.new(0.55, 0, 0.6, 0)
	noButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	noButton.TextColor3 = Color3.new(1,1,1)
	noButton.Text = "No"
	noButton.Font = Enum.Font.GothamBold
	noButton.TextSize = 16
	noButton.ZIndex =11

	yesButton.MouseButton1Click:Connect(function()
		screenGui:Destroy()
		destroyFollowPlatform()
	end)

	noButton.MouseButton1Click:Connect(function()
		confirmFrame:Destroy()
	end)
end)

-- Tweenでなめらか追尾処理
local function teleportTo(position)
	if not player.Character then return end
	local hrp = player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	if not followPlatform or not followPlatform.Parent then
		createFollowPlatform(hrp.Position - Vector3.new(0, 2.5, 0))
	end

	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end
	if followConnection then
		followConnection:Disconnect()
		followConnection = nil
	end

	local distance = (position - followPlatform.Position).Magnitude
	local time = distance / MOVE_SPEED

	currentTween = TweenService:Create(followPlatform, TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {Position = position})

	followConnection = RunService.RenderStepped:Connect(function()
		if followPlatform and followPlatform.Parent and hrp.Parent then
			hrp.CFrame = CFrame.new(
				followPlatform.Position + Vector3.new(0, 2.5, 0),
				followPlatform.Position + followPlatform.CFrame.LookVector
			)
		end
	end)

	currentTween:Play()
	currentTween.Completed:Connect(function()
		if followConnection then
			followConnection:Disconnect()
			followConnection = nil
		end
	end)
end

-- CamLock処理
RunService.Heartbeat:Connect(function()
	if camLock and selectedTarget and selectedTarget.Character then
		local cam = workspace.CurrentCamera
		local lookPos = nil

		if camLockPart == "Head" and selectedTarget.Character:FindFirstChild("Head") then
			lookPos = selectedTarget.Character.Head.Position
		elseif camLockPart == "Torso" and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
			lookPos = selectedTarget.Character.HumanoidRootPart.Position
		elseif camLockPart == "Legs" and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
			lookPos = selectedTarget.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
		end

		if lookPos then
			cam.CFrame = CFrame.new(cam.CFrame.Position, lookPos)
		end
	end
end)

local lastDistance = nil  -- 前フレームの距離を記録

RunService.Heartbeat:Connect(function()
	if randomMode then
		if randomTypeClose then
			pickRandomTarget()
		end
	end

	if moving and selectedTarget and selectedTarget.Character and selectedTarget.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			local targetPos = selectedTarget.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
			local distance = (hrp.Position - targetPos).Magnitude

			if lastDistance and (distance - lastDistance) > 1000 then
				-- 前回より一気に50以上距離が離れたら追尾やめる
				destroyFollowPlatform()
				moving = false
				updateButtonsText()
				lastDistance = nil
				return
			end

			teleportTo(targetPos)
			lastDistance = distance
		end
	else
		destroyFollowPlatform()
		lastDistance = nil
	end
end)
